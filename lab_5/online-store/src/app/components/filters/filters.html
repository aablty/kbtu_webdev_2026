<aside class="h-fit rounded-2xl border border-border bg-card p-4">
  @if (categories()?.top) {
    <div
      class="mb-3 rounded-lg bg-secondary px-3 py-2 text-sm font-medium text-secondary-foreground"
    >
      <p (click)="setCategory(categories()?.top?.id || '')" class="cursor-pointer">
        <b>
          {{ categories()?.top?.title }}
        </b>
        @if (categories()?.top?.count !== undefined) {
          <span class="ml-1 text-xs">{{ categories()?.top?.count }}</span>
        }
      </p>
    </div>
  }

  <ng-template #categoryNodes let-nodes let-level="level">
    <ul class="space-y-2" [class.pl-4]="level > 0" [class.mt-1]="level > 0">
      @for (node of nodes; track node.id) {
        <li>
          <div class="flex items-center justify-between gap-2 text-sm">
            <div class="flex min-w-0 items-center gap-2">
              @if (hasChildren(node)) {
                <button
                  type="button"
                  (click)="toggle(node)"
                  class="flex h-4 w-4 items-center justify-center text-xs leading-none text-muted-foreground rounded-full transition-colors hover:bg-secondary/50"
                  [attr.aria-label]="isExpanded(node) ? 'Collapse category' : 'Expand category'"
                >
                  @if (isExpanded(node)) {
                    <lucide-icon name="chevron-down" class="h-3 w-3"></lucide-icon>
                  } @else {
                    <lucide-icon name="chevron-right" class="h-3 w-3"></lucide-icon>
                  }
                </button>
              } @else {
                <lucide-icon
                  name="dot"
                  class="flex h-4 w-4 items-center justify-center text-xs leading-none text-muted-foreground"
                ></lucide-icon>
              }

              <p (click)="setCategory(node.id)" class="text-foreground cursor-pointer">
                <b>
                  {{ node.title }}
                </b>
                @if (node.count !== undefined) {
                  <span class="text-xs text-muted-foreground">{{ node.count }}</span>
                }
              </p>
            </div>
          </div>

          @if (node.items?.length && isExpanded(node)) {
            <ng-container
              *ngTemplateOutlet="
                categoryNodes;
                context: { $implicit: node.items, level: level + 1 }
              "
            ></ng-container>
          }
        </li>
      }
    </ul>
  </ng-template>

  <ng-container
    *ngTemplateOutlet="categoryNodes; context: { $implicit: categories()?.items ?? [], level: 0 }"
  ></ng-container>
</aside>
